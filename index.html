<!DOCTYPE html>
<html>
<head>
  <title>é–‹ç™ºç”¨ã‚¿ã‚¤ãƒãƒ¼çŸ³å·</title>
  
</head>
<style>
   body { font-family: sans-serif; text-align: center; margin-top: 40px; }
   .timer-box {
     border: 1px solid #ccc; margin: 20px auto; padding: 10px; width: 1000px; border-radius: 10px;
   }
   h2 { margin-bottom: 10px; }
   input, button { font-size: 30px; margin: 5px; padding: 5px 10px; }
   input[type="number"] { width: 150px; text-align: right; }
 .display-time {
     font-size: 210px;
     font-weight: bold;
     color: #f94903;
     margin-bottom: 15px;
   }

.apc-title { color: rgb(232, 3, 3); font-size: 40px;
   font-size: 95px;
 font-weight: bold;
 font-family: Arial, Helvetica, sans-serif;
 text-shadow: 3px 3px 6px #aaa;}

.shohin-title {
 color: #0077ee;
 font-size: 90px;
 font-weight: bold;
 font-family:Arial, Helvetica, sans-serif;
 text-shadow: 3px 3px 6px #aaa;

}
.recap-title {
 color: #003937;      /* ã‚ªãƒ¬ãƒ³ã‚¸ã£ã½ã„æ´¾æ‰‹ãªè‰² */
 font-size: 80px;
 font-weight: bold;
 text-shadow: 2px 2px 5px #aaa;
 font-family: 'Arial Black', sans-serif;
}
.comment-title {
 font-size: 60px;
 font-weight: bold;
 color: #000703;  /* ç·‘è‰²ã§ç›®ç«‹ã¤ */
 text-shadow: 1px 1px 3px #aaa;
 font-family: 'Arial Black', sans-serif;
}
.nextseg-title {
 font-size: 70px;
 font-weight: bold;
 color: #045d26; /* ç´«è‰² */
 text-shadow: 1px 1px 3px #aaa;
}
.Hanyou-title {
 font-size: 60px;
 font-weight: bold;
 color: #061104; /* ç·‘ */
 text-shadow: 1px 1px 3px #aaa;
}
.Ending-title {
 font-size: 70px;
 font-weight: bold;
 color: #0d0c0f; /* èŒ¶è‰² */
 text-shadow: 1px 1px 3px #aaa;
}
button {
 background-color: #5485bc; /* é»’èƒŒæ™¯ */
 color: #ffffff;   
 font-weight: bold;         /* ç™½æ–‡å­— */
 border: none;
 border-radius: 5px;
 cursor: pointer;
 transition: background-color 0.3s ease;
}

button:hover {
 background-color: #333333; /* ãƒ›ãƒãƒ¼æ™‚å°‘ã—æ˜ã‚‹ã */
}
.clock-time {
  font-size: 60px;
  color: #0a080a;
  margin-bottom: 10px;
  font-weight: bold;
}
.timer-box:last-child {
 margin-bottom: 70px;
  }
#scrollTopBtn, #scrollBottomBtn {
  position: fixed;
  right: 30px;
  padding: 15px;
  font-size: 20px;
  border: none;
  border-radius: 10px;
  background-color: #94b395;
  color: white;
  cursor: pointer;
  z-index: 1000;
  opacity: 0.8;
}

.adjust-buttons {
  font-size: 40px;
  padding: 10px 20px;
  margin: 5px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.adjust-plus {
  background-color: #f44336;  /* èµ¤ */
  color: white;
}

.adjust-minus {
  background-color: #35f33c;  /* ç·‘ */
  color: white;
}

.adjust-plus:hover {
  background-color: #a63229;
}

.adjust-minus:hover {
  background-color: #24a429;
}


#scrollTopBtn:hover, #scrollBottomBtn:hover {
  background-color: #4e5a46;
}

#scrollTopBtn {
  bottom: 100px;
}

#scrollBottomBtn {
  bottom: 30px;
}
/* æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ï¼ˆãã®ã¾ã¾æ®‹ã—ã¦OKï¼‰ */
    #password-box {
      position: fixed;
      top: 20px;
      right: 30px;
      background: #fff;
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      z-index: 2000;
    }
    #password-box input {
      font-size: 20px;
    }
    #password-box button {
      font-size: 18px;
      margin-left: 10px;
    }

 </style>

<body>
  <h1>é–‹ç™ºç”¨ã‚¿ã‚¤ãƒãƒ¼çŸ³å·</h1>

  <div id="timers"></div>

<div id="password-box" style="display: none; margin-top: 10px;">
  <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
  <button onclick="unlockAccess()">è§£é™¤</button>
</div>
<div id="timers"></div>


<button class="start-button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
<button class="reset-button">ãƒªã‚»ãƒƒãƒˆ</button>
<button class="adjust-plus">ï¼‹</button>
<button class="adjust-minus">âˆ’</button>

 <button id="scrollTopBtn">â†‘ å•†å“</button>
 <button id="scrollBottomBtn">â†“ Recap</button>

 <button id="showPasswordBtn">ğŸ”“ æ“ä½œè§£é™¤</button>


 
<script src="firebase-config.js"></script>
  
<script type="module">

//ã‚ªãƒ¼ãƒŠãƒ¼å‡¦ç†ã‚’Firebaseã«ä¿å­˜
  let deviceId = localStorage.getItem("deviceId");
  if (!deviceId) {
  deviceId = crypto.randomUUID();
  localStorage.setItem("deviceId", deviceId);
}
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
 ã€€import { get } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    
  const firebaseConfig = window.firebaseConfig;  
 

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let timeOffset = 0;
  const intervals = {};

//ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
  let isUnlocked = false;
const correctPassword = "9999"; // â† ä»»æ„ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´OK

document.getElementById("showPasswordBtn").onclick = () => {
  document.getElementById("password-box").style.display = "block";
  document.getElementById("showPasswordBtn").style.display = "none";
};

function unlockAccess() {
  const input = document.getElementById("passwordInput").value;
  if (input === correctPassword) {
    alert("èªè¨¼ã«æˆåŠŸ");
    isUnlocked = true;
    enableAllButtons();
  } else {
    alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }
}

function enableAllButtons() {
  document.querySelectorAll(".timer-box").forEach(box => {
    box.querySelectorAll("button").forEach(btn => btn.disabled = false);
  });
}


   // â¶ ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ™‚åˆ»å·®åˆ†ã‚’å–å¾—
function syncServerTimeOffset() {
  const offsetRef = ref(db, ".info/serverTimeOffset");
  onValue(offsetRef, (snapshot) => {
    if (snapshot.exists()) {
      timeOffset = snapshot.val();
      console.log("æ™‚åˆ»è£œæ­£: ", timeOffset, "ms");
    }
  });
}
syncServerTimeOffset(); // åˆæœŸåŒ–å¾Œã«å‘¼ã³å‡ºã™

// â· æ™‚è¨ˆæ›´æ–°ï¼ˆå·®åˆ†è£œæ­£ã‚ã‚Šï¼‰
function updateClockTime() {
  const correctedNow = new Date(Date.now() + timeOffset);
  const hh = String(correctedNow.getHours()).padStart(2, '0');
  const mm = String(correctedNow.getMinutes()).padStart(2, '0');
  const ss = String(correctedNow.getSeconds()).padStart(2, '0');
  const timeStr = `${hh}:${mm}:${ss}`;
  document.querySelectorAll(".clock-time").forEach(el => {
    el.innerText = timeStr;
  });

  requestAnimationFrame(updateClockTime); // â†æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å†å®Ÿè¡Œ
}

  requestAnimationFrame(updateClockTime);

   const timerLabels = [
     "å•†å“æ™‚é–“",
     "â‘ ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚º",
     "â‘¡ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚º",
     "â‘¢ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚º",
     "ãƒªã‚­ãƒ£ãƒƒãƒ—ã¾ã§",
     "APCã¾ã§",
     "æ¬¡ã‚»ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆã¾ã§",
     "ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¾ã§",  // â†è¿½åŠ 
     "æ±ç”¨ã‚¿ã‚¤ãƒãƒ¼"  // â†è¿½åŠ 
   ];

   const timerKeys = [
     "timer1", "timer2", "timer3", "timer4", "timer5", "timer6", "timer7","timer8","timer9"
   ];

   const container = document.getElementById("timers");

   timerLabels.forEach((label, i) => {
     const name = timerKeys[i];
     const isAPC = label.includes("APC");
     const isShohin = label.includes("å•†å“æ™‚é–“");
     const isRecap = label.includes("ãƒªã‚­ãƒ£ãƒƒãƒ—");
     const isComment = label.includes("ã‚³ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚º");
     const isNextSeg = label.includes("æ¬¡ã‚»ã‚°ã‚¹ã‚¿ãƒ¼ãƒˆ");
      const isEnding = label.includes("ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°");
       const isHanyou= label.includes("æ±ç”¨");


     const box = document.createElement("div");
     box.className = "timer-box";
     box.innerHTML = `
     <h2 class="${isAPC ? 'apc-title' : isShohin ? 'shohin-title' : isRecap ? 'recap-title' : isComment ? 'comment-title' : isNextSeg ? 'nextseg-title' : isEnding ? 'Ending-title' : isHanyou ? 'Hanyou-title' : ''}"${isRecap ? 'id="recapTimer"' : ''}>${label}</h2>

     <div class="clock-time">--:--:--</div> <!-- â˜…è¿½åŠ  -->

       <div id="display${i}" class="display-time">--:--:--</div>
       <input type="number" id="quick${i}" placeholder="ä¾‹: 15415" onchange="convertQuick(${i})"> â†ã¾ã¨ã‚ã¦å…¥åŠ›<br/>
       <input type="number" id="h${i}" min="0" value="0"> h
       <input type="number" id="m${i}" min="0" max="59" value="0"> m
       <input type="number" id="s${i}" min="0" max="59" value="0"> s <br/>
       <button onclick="startTimer('${name}', ${i})">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
       <button onclick="resetTimer('${name}', ${i})">ãƒªã‚»ãƒƒãƒˆ</button>
       

       <input type="number" id="adjust${i}" value="15" style="width: 80px; font-size: 24px;"> ç§’
      <button class="adjust-buttons adjust-plus" onclick="adjustTime('${name}', ${i}, true)">ï¼‹</button>
<button class="adjust-buttons adjust-minus" onclick="adjustTime('${name}', ${i}, false)">âˆ’</button>


     `;
     container.appendChild(box);

     const timerRef = ref(db, "sharedTimers/" + name);
     // â˜…ã“ã“ã«è¿½åŠ ï¼ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¶å¾¡ã™ã‚‹onValue
  onValue(timerRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    
    startDisplayLoop(name, i, timerRef);

         // è‡ªåˆ†ãŒã‚ªãƒ¼ãƒŠãƒ¼ã‹åˆ¤å®šã—ã¦ãƒœã‚¿ãƒ³åˆ¶å¾¡
    const isOwner = !data.owner || data.owner === deviceId || isUnlocked;

    const box = container.children[i];

    box.querySelector(".start-button").disabled = !isOwner; // ã‚¹ã‚¿ãƒ¼ãƒˆ
    box.querySelector(".reset-button").disabled = !isOwner; // ãƒªã‚»ãƒƒãƒˆ
    box.querySelector(".adjust-plus").disabled = !isOwner; // ï¼‹
    box.querySelector(".adjust-minus").disabled = !isOwner; // âˆ’
  });
       
     
     setupEnterKeyToStart(i, name); // â† ã“ã‚Œã‚’è¿½åŠ 

   });

  function formatTime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

  function getRemainingTime(startTime, duration) {
  const now = Date.now() + timeOffset;
  const elapsed = Math.floor((now - startTime) / 1000);
  return Math.max(0, duration - elapsed);
}


  window.startTimer = function (name, i) {
  const h = parseInt(document.getElementById("h" + i).value) || 0;
  const m = parseInt(document.getElementById("m" + i).value) || 0;
  const s = parseInt(document.getElementById("s" + i).value) || 0;
  const duration = h * 3600 + m * 60 + s;

 if (duration <= 0) return; // â˜…â† è¿½åŠ ï¼š0ç§’ä»¥ä¸‹ãªã‚‰ç„¡è¦–

  const timerRef = ref(db, "sharedTimers/" + name);

  const now = Date.now() + timeOffset;

  // è¡¨ç¤ºã‚’ã™ãåæ˜ ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®ä¸€æ‹å¾…ã¡ã‚’è§£æ¶ˆï¼‰
document.getElementById("display" + i).innerText = formatTime(duration);

  

   set(timerRef, {
    startTime: now,
    duration: duration,
    running: true,
    owner: deviceId
  });

  startDisplayLoop(name, i, timerRef);
  };
   

  window.resetTimer = function (name, i) {
  clearInterval(intervals[name]);
  const timerRef = ref(db, "sharedTimers/" + name);
  
  set(timerRef, {
    startTime: null,
    duration: 0,
    running: false,
    owner: null
  });

  document.getElementById("display" + i).innerText = formatTime(0);

  document.getElementById("h" + i).value = 0;
  document.getElementById("m" + i).value = 0;
  document.getElementById("s" + i).value = 0;
  document.getElementById("quick" + i).value = "";  // â† ã¾ã¨ã‚å…¥åŠ›æ¬„ã‚‚ã‚¯ãƒªã‚¢ï¼ˆä»»æ„ï¼‰
};



function startDisplayLoop(name, i, timerRef) {
  // ã™ã§ã«å‹•ã„ã¦ã„ã‚Œã°ä¸€åº¦æ­¢ã‚ã‚‹
  clearInterval(intervals["disp_" + name]);

  intervals["disp_" + name] = setInterval(() => {
    onValue(timerRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      let displayTime;
      if (data.running && data.startTime != null && data.duration != null) {
        const remaining = getRemainingTime(data.startTime, data.duration);
        displayTime = formatTime(remaining);

        if (remaining === 0) {
          set(timerRef, { running: false, startTime: null, duration: 0, owner: null });
        }
      } else {
        displayTime = formatTime(data.duration || 0);
      }

      document.getElementById("display" + i).innerText = displayTime;
    }, { onlyOnce: true });
  }, 500);
}


   window.adjustTime = function (name, i, isAdd) {
  const adjustInput = document.getElementById(`adjust${i}`);
  const adjustSeconds = parseInt(adjustInput.value) || 0;
  const timerRef = ref(db, "sharedTimers/" + name);

  get(timerRef).then((snapshot)=> {
    const data = snapshot.val();
    if (!data) return;

     let duration = data.duration || 0;
    let startTime = data.startTime || (Date.now() + timeOffset);
    let running = data.running;

    if (running) {
      const remaining = getRemainingTime(startTime, duration);
      const newRemaining = isAdd ? remaining + adjustSeconds : remaining - adjustSeconds;
      duration = newRemaining;
      startTime = Date.now() + timeOffset; // ä»Šã‚’å†ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ã«ã™ã‚‹
    } else {
      duration = isAdd ? duration + adjustSeconds : duration - adjustSeconds;
    }

    if (duration < 0) duration = 0;

    set(timerRef, {
      startTime: running ? startTime : null,
      duration: duration,
      running: running && duration > 0,
      owner: data.owner
    });

     const displayTime = formatTime(duration);
    document.getElementById("display" + i).innerText = displayTime;
  });
};


   window.convertQuick = function (i) {
     const val = document.getElementById("quick" + i).value.trim();
     if (!/^[0-9]+$/.test(val)) return;
     const padded = val.padStart(6, "0");
     const h = parseInt(padded.slice(0, -4)) || 0;
     const m = parseInt(padded.slice(-4, -2)) || 0;
     const s = parseInt(padded.slice(-2)) || 0;
     document.getElementById("h" + i).value = h;
     document.getElementById("m" + i).value = m;
     document.getElementById("s" + i).value = s;

   };

   // å…±é€šï¼šEnterã‚­ãƒ¼ã§ã‚¹ã‚¿ãƒ¼ãƒˆç™ºç«
function setupEnterKeyToStart(i, name) {
  const quick = document.getElementById(`quick${i}`);
  const h = document.getElementById(`h${i}`);
  const m = document.getElementById(`m${i}`);
  const s = document.getElementById(`s${i}`);

  [quick, h, m, s].forEach(input => {
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        startTimer(name, i);
      }
    });
  });
}

 

document.getElementById("scrollTopBtn").onclick = () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

document.getElementById("scrollBottomBtn").onclick = () => {
  const recapElement = document.getElementById("recapTimer");
  if (recapElement) {
    recapElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
};


</script>
</body>
</html>
